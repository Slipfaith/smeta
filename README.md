# RateApp — расчёт стоимости перевода

RateApp — десктопное приложение на Python/PySide6 для подготовки коммерческих предложений по переводам и сопутствующим услугам. Оно помогает проджект-менеджерам импортировать данные из Trados/Smartcat, Outlook, Excel или SharePoint/OneDrive, быстро рассчитывать стоимость проектов в разных валютах с учётом скидок, наценок и дополнительных услуг и формировать готовые документы для клиентов.

---

## Основные возможности

### Карточка проекта и управление контактами
- хранение названия проекта, клиента, контактного лица, e-mail, выбранного юридического лица и валюты расчёта;
- переключение языка интерфейса (RU/EN) и языка отображения расчётных таблиц;
- диалог проджект-менеджеров с историей контактов и автоподстановкой данных;
- настройка ставок НДС и режима расчёта только по новым словам и повторам.

### Языковые пары и тарифы
- создание и редактирование пар с сохранением пользовательских словарей языков на каждой платформе;
- автоматическая нормализация кодов языков через `langcodes` и `Babel`;
- отдельное окно «Панель ставок» с отображением тарифных сеток, подсветкой расхождений и сопоставлением значений с Excel;
- режим множественного редактирования тарифов и массового обновления скидок/наценок.

### Импорт данных
#### Отчёты CAT-систем
- перетаскивание XML-отчётов Trados и Smartcat напрямую в окно приложения;
- автоматическое распределение категорий объёмов и подсветка предупреждений.

#### Письма Outlook
- обработка `.msg` файлов (через `extract_msg`) для автозаполнения карточки проекта и таблиц расчёта;
- восстановление кэшов Outlook COM на Windows при необходимости.

#### Тарифные таблицы
- загрузка Excel-файлов с тарифами (листы `R1_*`/`R2_*`) и применение к выбранным языковым парам;
- интеграция с Microsoft 365: получение тарифов из SharePoint/OneDrive через Microsoft Graph с авторизацией MSAL по пути или `fileId`.

### Финансы и расчёты
- пересчёт итогов по всем услугам, учёт скидок/наценок и валютных округлений;
- конвертация валют через `online_rates.py` с ручным вводом курсов;
- блок «Запуск и управление проектом» с настраиваемыми работами, скидками и наценками;
- дополнительные услуги с произвольными единицами измерения и структурой.

### Экспорт и шаблоны
- сохранение проекта в JSON и загрузка без потери совместимости;
- выгрузка коммерческих предложений и оперативных таблиц ставок в Excel с учётом брендинга;
- экспорт в PDF через COM-интерфейс Excel на Windows;
- шаблоны и стили в каталоге `templates/` с возможностью кастомизации.

### Логирование и диагностика
- структурированные логи запуска и действий пользователя в Markdown-формате в каталоге `logs/` или `~/.smeta/logs`;
- доступ к последнему логу через меню «Проект → Открыть лог»;
- автоматическое закрытие зависших процессов Excel при выходе из приложения.

---

## Структура проекта

```text
.
├── main.py                      # Точка входа в приложение
├── gui/                         # Виджеты PySide6 и композиция интерфейса
│   ├── main_window.py           # Главное окно и меню
│   ├── panels/                  # Левая/правая панели с формами и таблицами
│   ├── additional_services.py   # Блок дополнительных услуг
│   ├── project_setup_widget.py  # Настройки запуска и управления проектом
│   ├── project_manager_dialog.py# Диалог проджект-менеджеров
│   ├── rates_manager_window.py  # Панель работы с тарифами
│   └── ...
├── logic/                       # Бизнес-логика и сервисные модули
│   ├── calculations.py          # Пересчёт итогов, валют и скидок
│   ├── project_manager.py       # Экспорт/импорт проектов, работа с файлами
│   ├── project_data.py          # Снимок данных проекта
│   ├── project_io.py            # Сохранение и загрузка JSON-проектов
│   ├── rates_importer.py        # Импорт тарифов из Excel
│   ├── outlook_import/          # Парсинг Outlook `.msg`
│   ├── sc_xml_parser.py         # Парсер отчётов Smartcat
│   ├── trados_xml_parser.py     # Парсер отчётов Trados
│   ├── ms_graph_client.py       # Работа с Microsoft Graph
│   ├── online_rates.py          # Курсы валют и конвертация
│   ├── activity_logger.py       # Markdown-журнал действий пользователя
│   ├── env_loader.py            # Загрузка `.env` из распространённых мест
│   ├── service_config.py        # Настройки окружения и путей
│   ├── logging_utils.py         # Настройка логирования
│   ├── user_config.py           # Пользовательские настройки интерфейса
│   └── ...
├── services/                    # Адаптеры интеграций
│   ├── excel_export.py          # Экспорт Qt-таблиц в Excel (LogTab, MemoQ)
│   └── ms_graph.py              # Обёртка над Microsoft Graph клиентом
├── rates1/                      # Встроенные вкладки управления тарифами
├── templates/                   # Excel-шаблоны и ресурсы для экспорта
├── utils/                       # Дополнительные утилиты интерфейса/истории
├── tests/                       # Набор unit-тестов (pytest)
├── requirements.txt             # Зависимости проекта
├── main.spec                    # Конфигурация PyInstaller
└── resource_utils.py            # Поиск ресурсов для dev-режима и сборки
```

Подробное описание архитектуры и взаимодействия модулей приведено в [ARCHITECTURE.md](ARCHITECTURE.md).

---

## Установка и запуск из исходников

### Требования
- Python 3.11

### Шаги установки

1. Создайте и активируйте виртуальное окружение:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # На Windows: .venv\Scripts\activate
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

3. Запустите приложение:
   ```bash
   python main.py
   ```

### Дополнительные требования

- **Windows + Excel** — необходимы для экспорта в PDF и корректной работы COM (`pywin32`).
- **Outlook `.msg`** — импорт писем выполняется через `extract_msg` (ставится из `requirements.txt`).
- **Доступ в интернет** — требуется для загрузки тарифов из Microsoft 365 и обновления курсов валют вручную.

---

## Тестирование

В проекте используется `pytest`. Для запуска тестов выполните:

```bash
pytest
```

Тесты покрывают расчёты, парсинг XML/Outlook, работу с конфигурациями и утилиты экспорта/импорта.

---

## Зависимости и технологии

- **Python 3.11** — основная версия интерпретатора.
- **PySide6** — Qt-интерфейс для настольного приложения.
- **pandas** и **openpyxl** — табличные расчёты и работа с Excel.
- **Pillow** — обработка изображений и иконок.
- **langcodes** и **Babel** — локализация и нормализация языковых кодов.
- **requests** — сетевые запросы к Microsoft Graph.
- **msal** — аутентификация пользователей Microsoft 365.
- **psutil** — диагностика процессов и завершение Excel при выходе.
- **extract_msg** — парсинг писем Outlook в формате `.msg`.
- **python-dotenv** — загрузка локальных настроек окружения.
- **pywin32** *(только Windows)* — взаимодействие с COM-объектами Microsoft Office для экспорта в PDF.

---

## Хранение пользовательских данных

### Файлы конфигурации

**`languages.json`** — пользовательский список языков. Располагается в:
- Windows: `%APPDATA%/ProjectCalculator`
- macOS: `~/Library/Application Support/ProjectCalculator`
- Linux: `~/.config/ProjectCalculator`

**`pm_history.json`** — история проджект-менеджеров. Сохраняется в той же директории.

**`logic/legal_entities.json`** — справочник юридических лиц, поставляется вместе с приложением.

---

## Сборка standalone-версии

Для сборки PyInstaller используйте подготовленный `main.spec`:

```bash
pyinstaller main.spec
```

Spec-файл добавляет шаблоны, локализационные данные Babel/langcodes и иконку приложения. При необходимости можно скорректировать список ресурсов или имя выходного файла.

---

## Логи и обратная связь

- Логи последнего запуска доступны через «Проект → Открыть лог». Файлы логов вращаются и сохраняются в `./logs`, `~/.smeta/logs` или во временном каталоге системы.
- Журнал действий пользователя (`activity.log`) включает структурированные записи с основными шагами и снимками данных.

---

## Поддержка и вклад

Пул-реквесты приветствуются. Перед внесением изменений:

1. Запустите `pytest` и убедитесь, что тесты проходят.
2. Обновите документацию, если изменяется функциональность интерфейса или процессы импорта/экспорта.

Если вы обнаружили ошибку, создайте issue с описанием:
- версии приложения;
- шагов воспроизведения;
- лог-файла (по возможности).
