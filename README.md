# RateApp — расчет стоимости перевода

RateApp — десктопное приложение на Python/PySide6 для подготовки коммерческих предложений по переводам и сопутствующим услугам. Помогает проджект-менеджерам импортировать данные из Trados/Smartcat, Outlook, Excel с тарифами и быстро рассчитывать стоимость проектов в разных валютах с учётом скидок, наценок и дополнительных услуг.

---

## Основные возможности

### Карточка проекта
Хранение названия, клиента, контактного лица, e-mail, выбора юридического лица, валюты и ставок НДС. Поддерживается переключение языка интерфейса (RU/EN) и отображения языков в расчётах.

### Языковые пары
Создание и редактирование пар с сохранением пользовательских справочников языков в:
- Windows: `%APPDATA%/ProjectCalculator`
- macOS: `~/Library/Application Support/ProjectCalculator`
- Linux: `~/.config/ProjectCalculator`

Есть режим расчёта только по новым словам и повторам.

### Импорт отчётов
Перетаскивание XML-отчётов Trados/Smartcat с автоматическим распределением категорий объёмов и подсветкой предупреждений.

### Импорт писем Outlook
Обработка `.msg` файлов (через `extract_msg`) для автоматического заполнения карточки проекта данными из письма и HTML-таблиц.

### Импорт тарифов
Загрузка Excel-файлов с тарифами (листы `R1_*`/`R2_*` в разных валютах) с дальнейшим применением к выбранным языковым парам.
Дополнительно поддерживается получение тарифов из SharePoint/OneDrive через Microsoft Graph
с интерактивной авторизацией MSAL и идентификацией файла по пути либо `fileId`.

### Дополнительные услуги
Несколько таблиц с произвольными услугами, единицами измерения, скидками и наценками.

### Экспорт
Сохранение проекта в JSON, выгрузка КП и оперативных таблиц ставок в Excel и PDF. PDF требует установленный Excel и `pywin32` на Windows.
Экспорт вкладок LogTab/MemoQ формирует стилизованные листы с автоформатированием валют и чисел.
Шаблоны находятся в каталоге `templates/` и поддерживают корпоративный брендинг.

### Работа с курсами
Пересчёт тарифов из USD в RUB с учётом ручного ввода курса, валютных символов и округлений.

### Журналы и логирование
Подробные логи запускаются автоматически и сохраняются в `logs/` внутри проекта, в `~/.smeta/logs` или во временной директории системы. Последний лог доступен через меню «Открыть лог».

### Автообновления
Проверка новых релизов на GitHub, скачивание обновлений и запуск инсталлятора на Windows.

### Интеграция с Microsoft 365
Интерактивная авторизация и работа с файлами в SharePoint через Microsoft Graph для загрузки тарифов напрямую из корпоративного хранилища.

---

## Структура проекта

```text
.
├── main.py                      # Точка входа в приложение
├── gui/                         # Виджеты PySide6 и композиция главного окна
│   ├── panels/                  # Левая/правая панель с формами и таблицами
│   └── ...
├── logic/                       # Бизнес-логика и сервисные модули
│   ├── outlook_import/          # Парсинг Outlook .msg и преобразование в данные проекта
│   ├── calculations.py          # Пересчёт итогов, валют и скидок
│   ├── excel_exporter.py        # Формирование Excel КП
│   ├── pdf_exporter.py          # Экспорт в PDF через COM-интерфейс Excel
│   ├── importers.py             # Высокоуровневые импортеры XML/Outlook
│   ├── rates_importer.py        # Импорт тарифов из Excel
│   ├── translation_config.py    # Локализация текста интерфейса (RU/EN)
│   └── ...
├── templates/                   # Excel-шаблоны, логотипы и ресурсы для экспорта
├── updater/                     # Проверка обновлений и метаданные релиза
├── tests/                       # Набор unit-тестов (pytest)
├── requirements.txt             # Список зависимостей проекта
├── main.spec                    # Конфигурация PyInstaller
└── resource_utils.py            # Поиск ресурсов для дев-режима и PyInstaller
```

Подробное описание архитектуры и взаимодействия модулей доступно в [ARCHITECTURE.md](ARCHITECTURE.md).

---

## Установка и запуск из исходников

### Требования
- Python 3.11

### Шаги установки

1. Создайте и активируйте виртуальное окружение:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # На Windows: .venv\Scripts\activate
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

3. Запустите приложение:
   ```bash
   python main.py
   ```

### Дополнительные требования

- **Windows + Excel** — необходимы для экспорта в PDF и применения региональных настроек чисел через COM (`pywin32`)
- **Outlook `.msg`** — для импорта требуется пакет `extract_msg` (устанавливается автоматически из `requirements.txt`)
- **Интернет** — используется для проверки обновлений и скачивания релизов

---

## Тестирование

В проекте используется `pytest`. Для запуска тестов выполните:

```bash
pytest
```

Тесты покрывают расчёты, парсинг XML/Outlook, работу с конфигурациями и утилиты экспорта/импорта.

---

## Зависимости и технологии

- **Python 3.11** — основная версия интерпретатора, на которой разрабатывается и тестируется приложение.
- **PySide6** — Qt-интерфейс для настольного приложения.
- **pandas** — табличные расчёты и подготовка данных к экспорту.
- **openpyxl** — запись и форматирование Excel-файлов.
- **Pillow** — работа с изображениями и иконками.
- **langcodes** и **Babel** — локализация и нормализация языковых кодов.
- **requests** — сетевые запросы к Microsoft Graph и обновлениям.
- **msal** — аутентификация пользователей для Microsoft 365.
- **psutil** — системные сведения для диагностики и корректного завершения процессов Excel.
- **extract_msg** — парсинг писем Outlook в формате `.msg`.
- **python-dotenv** — загрузка локальных настроек окружения.
- **pywin32** *(только Windows)* — взаимодействие с COM-объектами Microsoft Office для экспорта в PDF.

---

## Хранение пользовательских данных

### Файлы конфигурации

**`languages.json`** — пользовательский список языков  
Располагается в:
- Windows: `%APPDATA%/ProjectCalculator`
- macOS: `~/Library/Application Support/ProjectCalculator`
- Linux: `~/.config/ProjectCalculator`

**`pm_history.json`** — история проджект-менеджеров  
Сохраняется в той же директории, что и `languages.json`

**`logic/legal_entities.json`** — справочник юридических лиц  
Поставляется вместе с приложением и упаковывается в сборку

---

## Сборка standalone-версии

Для сборки PyInstaller используйте подготовленный `main.spec`:

```bash
pyinstaller main.spec
```

Spec-файл добавляет шаблоны, локализационные данные Babel/langcodes и иконку приложения. Если нужно, можно скорректировать список ресурсов или имя выходного файла.

---

## Обновления и логирование

### Обновления
Меню «Обновление → Проверить обновления» обращается к GitHub Releases и при наличии новой версии скачивает установщик и запускает обновление (Windows) либо предлагает скачать архив.

### Логирование
Логи последнего запуска доступны через «Проект → Открыть лог». Файлы логов вращаются и сохраняются в одной из директорий:
- `./logs`
- `~/.smeta/logs`
- Системный временный каталог

---

## Поддержка и вклад

Пул-реквесты приветствуются. Перед внесением изменений:

1. Запустите `pytest` и убедитесь, что тесты проходят
2. Опишите изменения в README, если они затрагивают функциональность интерфейса или процессы импорта/экспорта

Если вы обнаружили ошибку, создайте issue с описанием:
- Версии приложения
- Шагов воспроизведения
- Лог-файла (по возможности)