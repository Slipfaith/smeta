# RateApp — калькулятор стоимости перевода

RateApp — это десктопное приложение на Python/PySide6 для подготовки
коммерческих предложений по переводам и сопутствующим услугам. Оно помогает
проджект-менеджерам импортировать исходные данные из Trados/Smartcat,
электронной почты Outlook, Excel-листов с тарифами и быстро рассчитывать
стоимость проектов в разных валютах с учётом скидок, наценок и дополнительных
услуг.

## Основные возможности

- **Карточка проекта**: хранение названия, клиента, контактного лица, e-mail,
  выбора юридического лица, валюты и ставок НДС. Поддерживается переключение
  языка интерфейса (RU/EN) и отображения языков в расчётах (RU или EN).
- **Языковые пары**: создание и редактирование пар с сохранением пользовательских
  справочников языков в `%APPDATA%/ProjectCalculator` (Windows),
  `~/Library/Application Support/ProjectCalculator` (macOS) или
  `~/.config/ProjectCalculator` (Linux). Есть режим расчёта только по новым
  словам и повторам.
- **Импорт отчётов**: перетаскивание XML-отчётов Trados/Smartcat с автоматическим
  распределением категорий объёмов и подсветкой предупреждений.
- **Импорт писем Outlook**: обработка `.msg` файлов (через `extract_msg`) для
  автоматического заполнения карточки проекта данными из письма и HTML-таблиц.
- **Импорт тарифов**: загрузка Excel-файлов с тарифами (листы `R1_*`/`R2_*` в
  разных валютах) с дальнейшим применением к выбранным языковым парам.
- **Дополнительные услуги**: несколько таблиц с произвольными услугами,
  единицами измерения, скидками и наценками.
- **Экспорт**: сохранение проекта в JSON, выгрузка КП в Excel и PDF (PDF требует
  установленный Excel и `pywin32` на Windows). Шаблоны находятся в каталоге
  `templates/` и поддерживают корпоративный брендинг.
- **Работа с курсами**: пересчёт тарифов из USD в RUB с учётом ручного ввода
  курса, валютных символов и округлений.
- **Журналы и логирование**: подробные логи запускаются автоматически и
  сохраняются в `logs/` внутри проекта, в `~/.smeta/logs` или во временной
  директории системы. Последний лог доступен через меню «Открыть лог».
- **Автообновления**: проверка новых релизов на GitHub, скачивание обновлений и
  запуск инсталлятора на Windows.

## Структура проекта

```text
.
├── main.py                 # Точка входа в приложение
├── gui/                    # Виджеты PySide6 и композиция главного окна
│   ├── panels/             # Левая/правая панель с формами и таблицами
│   └── ...
├── logic/                  # Бизнес-логика и сервисные модули
│   ├── outlook_import/     # Парсинг Outlook .msg и преобразование в данные проекта
│   ├── calculations.py     # Пересчёт итогов, валют и скидок
│   ├── excel_exporter.py   # Формирование Excel КП
│   ├── pdf_exporter.py     # Экспорт в PDF через COM-интерфейс Excel
│   ├── importers.py        # Высокоуровневые импортеры XML/Outlook
│   ├── rates_importer.py   # Импорт тарифов из Excel
│   ├── translation_config.py  # Локализация текста интерфейса (RU/EN)
│   └── ...
├── templates/              # Excel-шаблоны, логотипы и ресурсы для экспорта
├── updater/                # Проверка обновлений и метаданные релиза
├── tests/                  # Набор unit-тестов (pytest)
├── requirements.txt        # Список зависимостей проекта
├── main.spec               # Конфигурация PyInstaller
└── resource_utils.py       # Поиск ресурсов для дев-режима и PyInstaller
```

## Установка и запуск из исходников

1. Убедитесь, что установлен Python 3.10+.
2. Создайте и активируйте виртуальное окружение:

   ```bash
   python -m venv .venv
   source .venv/bin/activate  # На Windows: .venv\Scripts\activate
   ```

3. Установите зависимости (на Windows будут подтянуты `pywin32` и `extract_msg`):

   ```bash
   pip install -r requirements.txt
   ```

4. Запустите приложение:

   ```bash
   python main.py
   ```

### Дополнительные требования

- **Windows + Excel**: необходимы для экспорта в PDF и применения региональных
  настроек чисел через COM (`pywin32`).
- **Outlook `.msg`**: для импорта требуется пакет `extract_msg` (устанавливается
  автоматически из `requirements.txt`).
- **Интернет**: используется для проверки обновлений и скачивания релизов.

## Тестирование

В проекте используется `pytest`. Для запуска тестов выполните:

```bash
pytest
```

Тесты покрывают расчёты, парсинг XML/Outlook, работу с конфигурациями и утилиты
экспорта/импорта.

## Хранение пользовательских данных

- `languages.json` — пользовательский список языков. Располагается в
  `%APPDATA%/ProjectCalculator` (Windows), `~/Library/Application Support/ProjectCalculator`
  (macOS) или `~/.config/ProjectCalculator` (Linux).
- `pm_history.json` — история проджект-менеджеров (в той же директории, что и
  `languages.json`).
- `logic/legal_entities.json` — справочник юридических лиц, поставляется вместе
  с приложением и упаковывается в сборку.

## Сборка standalone-версии

Для сборки PyInstaller можно использовать подготовленный `main.spec`:

```bash
pyinstaller main.spec
```

Spec-файл добавляет шаблоны, локализационные данные Babel/langcodes и иконку
приложения. Если нужно, можно скорректировать список ресурсов или имя выходного
файла.

## Обновления и логирование

- Меню «Обновление → Проверить обновления» обращается к GitHub Releases и, при
  наличии новой версии, скачивает установщик и запускает обновление (Windows)
  либо предлагает скачать архив.
- Логи последнего запуска доступны через «Проект → Открыть лог». Файлы логов
  вращаются и сохраняются в одной из директорий: `./logs`, `~/.smeta/logs` или
  системный временный каталог.

## Поддержка и вклад

Пул-реквесты приветствуются. Перед внесением изменений:

1. Запустите `pytest` и убедитесь, что тесты проходят.
2. Опишите изменения в README, если они затрагивают функциональность
   интерфейса или процессы импорта/экспорта.

Если вы обнаружили ошибку, создайте issue с описанием версии приложения,
шагов воспроизведения и (по возможности) приложите лог-файл.

