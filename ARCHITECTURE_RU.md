# Архитектура RateApp

## Обзор

RateApp использует многослойную архитектуру (**UI → Бизнес-логика → Сервисы интеграций**) поверх PySide6. Интерфейс отвечает за отображение и ввод данных, а расчёты, импорт/экспорт и интеграции вынесены в специализированные модули. Потоки данных из Trados/Smartcat, Outlook, Excel и Microsoft 365 проходят через единый конвейер и завершаются готовыми коммерческими предложениями.

Ключевые принципы:
- **Разделение ответственности** — UI-компоненты не содержат бизнес-логики и обращаются к модулям `logic/` и `services/`;
- **Переиспользуемость** — импортеры и экспортеры используются как главным окном, так и встроенными утилитами (панель ставок);
- **Готовность к упаковке** — `resource_utils.py`, `env_loader.py` и шаблоны обеспечивают одинаковую работу в исходниках и сборках PyInstaller.

---

## Слои приложения

### 1. Точка входа
**`main.py`**
- загружает `.env` и настраивает логирование (`env_loader.load_application_env`, `logging_utils.setup_logging`);
- фиксирует запуск через `activity_logger`;
- создаёт `QApplication`, устанавливает иконку и запускает `TranslationCostCalculator`;
- по завершении закрывает оставшиеся процессы Excel (`excel_process.close_excel_processes`).

### 2. Пользовательский интерфейс (`gui/`)
- **`main_window.py`** — композиция главного окна, меню, обработка Drag & Drop, связь с `ProjectManager`;
- **`panels/`** — левая/правая панели с карточкой проекта, списком языковых пар и сводками;
- **`language_pair.py`**, **`additional_services.py`** — виджеты расчётов по языковым парам и дополнительным услугам;
- **`project_setup_widget.py`** — блок «Запуск и управление проектом» с задачами, скидками и наценками;
- **`project_manager_dialog.py`** — выбор и редактирование проджект-менеджеров;
- **`rates_manager_window.py`** — панель ставок с сопоставлением Excel-значений и подсветкой расхождений;
- **`drop_areas.py`** — обработка перетаскивания XML/MSG/Excel;
- **`styles.py`**, **`utils.py`** — стили, форматирование и вспомогательные утилиты.

Виджеты используют mixin `LanguagePairsMixin` и функции из `logic/` для пересчёта итогов, импорта и экспорта.

### 3. Бизнес-логика (`logic/`)

**Управление проектами**
- `project_manager.py` — фасад операций (сохранение/загрузка проектов, экспорт Excel/PDF, очистка);
- `project_data.py` — неизменяемый снимок данных проекта для экспорта и логов;
- `project_io.py` — сериализация/десериализация JSON-проектов с проверкой версий;
- `pm_store.py` — хранение истории проджект-менеджеров;
- `user_config.py` — пользовательские настройки (язык, валюта по умолчанию).

**Расчёты и справочники**
- `calculations.py` — подсчёт итогов, скидок/наценок, НДС;
- `online_rates.py` — хранение и пересчёт курсов валют;
- `language_pairs.py`, `language_codes.py` — модели языковых пар и нормализация кодов;
- `legal_entities.py` + `legal_entities.json` — справочник юрлиц и путей к шаблонам.

**Импорт**
- `importers.py` — фасады импорта отчётов и тарифов;
- `sc_xml_parser.py`, `trados_xml_parser.py`, `xml_parser_common.py` — парсеры CAT-отчётов;
- `outlook_import/` — обработка Outlook `.msg` (карточка, таблицы, вложения);
- `excel_process.py`, `rates_importer.py` — чтение Excel, нормализация и применение тарифов;
- `ms_graph_client.py` — работа с Microsoft Graph (MSAL, поиск по пути или `fileId`).

**Экспорт**
- `excel_exporter.py` — генерация Excel-шаблонов коммерческих предложений;
- `pdf_exporter.py` — конвертация Excel → PDF через COM (Windows);
- `activity_logger.py` — структурированный Markdown-журнал действий для диагностики.

**Инфраструктура**
- `env_loader.py`, `service_config.py` — конфигурация окружения и путей;
- `logging_utils.py`, `activity_logger.py` — настройка логирования и журналирование действий;
- `progress.py` — индикаторы долгих операций;
- `outlook_com_cache.py` — обслуживание COM-кэша Outlook на Windows;
- `app_info.py` — метаданные приложения.

### 4. Сервисы интеграций (`services/`)
- `excel_export.py` — экспорт Qt-таблиц (LogTab, MemoQ и др.) с автоформатированием;
- `ms_graph.py` — высокоуровневая обёртка над `ms_graph_client` с возвратом `pandas.DataFrame` и логированием ошибок.

---

## Вспомогательные каталоги
- **`templates/`** — Excel-шаблоны, логотипы и прочие ресурсы экспорта;
- **`rates1/`** — встроенные вкладки легаси-инструмента тарифов для `rates_manager_window.py`;
- **`utils/`** — утилиты интерфейса (`history.py`, `theme.py`);
- **`tests/`** — pytest-набор для расчётов, импорта/экспорта и утилит;
- **`resource_utils.py`** — универсальный поиск ресурсов для исходников и PyInstaller;
- **`requirements.txt`**, **`main.spec`**, **`rateapp.ico`**, **`RateApp.exe.sha256`** — файлы инфраструктуры сборки.

---

## Потоки данных

### 1. Импорт
```text
Действие пользователя (Drag & Drop / диалог / Microsoft Graph)
    ↓
logic/importers.py
    ↓
Парсеры форматов (XML, Outlook MSG, Excel)
    ↓
Виджеты LanguagePair / ProjectSetupWidget / AdditionalServicesWidget
    ↓
ProjectManager + ProjectData
```
**Источники:** Trados/Smartcat XML, Outlook `.msg`, локальные и облачные Excel-тарифы.

### 2. Обработка
```text
ProjectManager (агрегация состояния)
    ↓
calculations.py (итоги, скидки, НДС)
    ↓
online_rates.py (конвертация валют)
    ↓
project_data.py (снимок для экспорта/логов)
```
Справочники (`legal_entities`, `pm_store`, `user_config`) предоставляют метаданные и пользовательские настройки.

### 3. Экспорт
```text
Запрос пользователя (меню «Экспорт»)
    ↓
project_manager.py
    ↓
excel_exporter.py  ──→  templates/
    └── pdf_exporter.py (опционально, Windows)
    ↓
Выходные файлы (Excel / PDF / JSON)
```
`activity_logger` параллельно сохраняет структурированные записи и при необходимости прикладывает снимки данных.

### 4. Внешние сервисы
```text
Запросы Microsoft Graph ← ms_graph_client.py → MSAL-аутентификация
    ↓
services/ms_graph.py (нормализация и кеширование данных)
```

---

## Преимущества
- **Поддерживаемость** — слои UI, логики и сервисов модифицируются независимо;
- **Расширяемость** — новые парсеры, шаблоны и источники данных добавляются без изменений UI;
- **Диагностика** — расширенное логирование (`logging_utils`, `activity_logger`) фиксирует действия пользователей;
- **Готовность к сборке** — единый поиск ресурсов упрощает PyInstaller-пакетирование.
