# Архитектура RateApp

## Обзор

RateApp — настольное приложение на базе PySide6, построенное по принципу многослойной архитектуры: **UI → Бизнес-логика → Сервисы интеграции**. Приложение управляет данными переводческих проектов из множества источников (отчёты Trados/Smartcat, письма Outlook, файлы Excel, SharePoint) и формирует профессиональные коммерческие предложения в форматах Excel и PDF.

### Основные принципы

- **Разделение ответственности**: UI-компоненты делегируют всю бизнес-логику и операции ввода-вывода выделенным модулям
- **Централизованная обработка данных**: Все данные проектов проходят через единый конвейер обработки
- **Модульная интеграция**: Внешние сервисы обёрнуты в лёгкие адаптеры
- **Управление ресурсами**: Поддержка как режима разработки, так и упакованного PyInstaller развёртывания

---

## Архитектурные слои

### 1. Точка входа
**`main.py`**
- Инициализация приложения
- Настройка конфигурации и локализации
- Создание главного окна

### 2. Слой пользовательского интерфейса (`gui/`)
Обрабатывает все взаимодействия с пользователем и визуальное представление на основе виджетов PySide6.

**Структура:**
```
gui/
├── __init__.py          # Регистрация виджетов
├── main_window.py       # Композиция главного окна
├── panels/              # Панели по функциям
│   ├── Карточка проекта
│   ├── Языковые пары
│   ├── Дополнительные услуги
│   └── Журнал активности
├── dialogs/             # Модальные диалоги
│   ├── Выбор файлов
│   ├── Настройки
│   └── Подтверждения
└── models/              # Модели данных Qt
    └── Таблицы и деревья для расчётов
```

**Зоны ответственности:**
- Отображение данных проекта из моделей `logic/`
- Захват пользовательского ввода и запуск бизнес-операций
- Показ индикаторов прогресса и обратной связи при валидации

### 3. Слой бизнес-логики (`logic/`)
Содержит все базовые бизнес-правила, расчёты и преобразования данных.

#### Основные модули

**Управление проектами:**
- `project_manager.py` — Центральный агрегатор состояния проекта, координирует карточки, языковые пары, услуги и расчёты
- `project_io.py` — Сериализация/десериализация проектов с поддержкой версий
- `pm_store.py` — История контактов менеджеров проектов и автозаполнение

**Расчёты и финансы:**
- `calculations.py` — Вычисления объёмов, валют, скидок, налогов и итоговых сумм
- `online_rates.py` — Хранение курсов валют и их обновление

**Конвейер импорта:**
- `importers.py` — Высокоуровневые фасады импорта
- `sc_xml_parser.py` — Парсер отчётов Smartcat
- `trados_xml_parser.py` — Парсер отчётов Trados
- `outlook_import/` — Парсер файлов `.msg` (заголовки, тело, таблицы)
- `xml_parser_common.py` — Общие утилиты парсинга XML
- `excel_process.py` — Чтение и нормализация данных Excel

**Конвейер экспорта:**
- `excel_exporter.py` — Генерация коммерческих предложений на основе шаблонов
- Система рендеринга на базе шаблонов

**Справочные данные:**
- `language_pairs.py` — Модели языковых пар и управление пользовательскими справочниками
- `language_codes.py` — Нормализация языковых кодов с помощью `langcodes`/`Babel`
- `legal_entities.py` + `legal_entities.json` — Справочные данные юридических лиц

**Интеграция с Microsoft Graph:**
- `ms_graph_client.py` — Низкоуровневый клиент MS Graph API (MSAL-аутентификация, файловые операции по пути и `fileId`)

**Инфраструктура:**
- `service_config.py` — Конфигурация окружения (загрузка `.env`, пути)
- `user_config.py` — Пользовательские настройки (валюта по умолчанию, язык интерфейса)
- `translation_config.py` — Локализация интерфейса и терминологии
- `logging_utils.py` — Конфигурация логирования и управление файлами журналов
- `progress.py` — Отслеживание прогресса долгих операций

### 4. Слой сервисов интеграции (`services/`)
Лёгкие адаптеры для внешних API и поддержки легаси-компонентов.

**Модули:**
- `excel_export.py` — Экспорт моделей таблиц Qt в Excel с автоформатированием (поддержка легаси-вкладок, LogTab, MemoQ)
- `ms_graph.py` — Обёртка совместимости над `logic.ms_graph_client`, нормализует области доступа, логирует ошибки, возвращает объекты `DataFrame`

---

## Вспомогательные компоненты

### Управление ресурсами
**`utils/resource_utils.py`**
- Поиск шаблонов и переводов
- Обработка режима разработки и режима PyInstaller-пакета

### Статические ресурсы
**`templates/`**
- Шаблоны Excel для коммерческих предложений
- Ресурсы для генерации PDF

### Система обновлений
**`updater/`**
- Управление метаданными релизов
- Проверка и установка пакетов обновлений
- Контроль версий

### Тестирование
**`tests/`**
- Юнит-тесты для расчётов
- Валидация парсеров
- Покрытие сервисных функций

### Сборка и развёртывание
- `requirements.txt` — Внешние зависимости с ограничениями версий
- `main.spec` — Конфигурация сборки PyInstaller (бинарники, шаблоны, переводы)
- `rateapp.ico` — Иконка приложения
- `RateApp.exe.sha256` — Контрольные суммы артефактов сборки

---

## Архитектура потоков данных

### 1. Фаза импорта
```
Действие пользователя (Drag & Drop / MS Graph)
    ↓
importers.py (Фасад импорта)
    ↓
Парсеры конкретных форматов (XML/MSG/Excel)
    ↓
Модели языковых пар
    ↓
project_manager.py (Агрегация данных)
```

**Источники:**
- XML-отчёты Trados/Smartcat
- Файлы `.msg` из Outlook
- Электронные таблицы Excel
- SharePoint через Microsoft Graph

### 2. Фаза обработки
```
project_manager.py (Координация состояния)
    ↓
calculations.py (Расчёт стоимости)
    ↓
online_rates.py (Конвертация валют)
    ↓
project_io.py (Сохранение состояния)
```

**Интеграция справочных данных:**
- `language_pairs.py` — Языковые комбинации
- `pm_store.py` — Контакты менеджеров проектов
- `user_config.py` — Пользовательские настройки
- `legal_entities.py` — Информация о компании

### 3. Фаза экспорта
```
Запрос на экспорт
    ↓
excel_exporter.py (Обработка шаблонов)
    ├→ services/excel_export.py (Поддержка легаси-форматов)
    └→ pdf_exporter.py (Генерация PDF)
    ↓
Выходные файлы (Excel/PDF)
```

### 4. Внешняя интеграция
```
Проверка обновлений → updater/ → Метаданные релизов
    ↓
ms_graph_client.py ← MSAL Auth → Microsoft Graph API
    ↓
services/ms_graph.py (Нормализация данных)
```

---

## Преимущества архитектуры

### Поддерживаемость
- **Чёткие границы** между UI, логикой и сервисами
- **Независимая эволюция** бизнес-правил без изменения UI
- **Тестируемые компоненты** с минимальными требованиями к моккированию

### Расширяемость
- **Плагинная система парсеров** для новых форматов отчётов
- **Абстракция сервисов** позволяет заменять интеграции
- **Экспорт на основе шаблонов** позволяет кастомизировать без изменения кода

### Переиспользуемость
- **Слой сервисов** поддерживает как новые, так и легаси-компоненты
- **Общие утилиты** предотвращают дублирование кода
- **Модульные импортеры** могут быть скомпонованы для сложных процессов

---

## Технологический стек

- **UI-фреймворк**: PySide6 (Qt для Python)
- **Обработка языков**: `langcodes`, `Babel`
- **Операции с Excel**: `openpyxl`, `pandas`
- **Аутентификация**: MSAL (Microsoft Authentication Library)
- **API-интеграция**: Microsoft Graph API
- **Инструмент сборки**: PyInstaller
- **Тестирование**: `pytest` (стандартное юнит-тестирование)

---

## Рекомендации по разработке

### Добавление новых функций
1. Реализовать бизнес-логику в `logic/` с юнит-тестами
2. Создать UI-компоненты в `gui/`, использующие модели логики
3. Добавить адаптеры интеграции в `services/` при необходимости работы с внешними API
4. Обновить конфигурацию в `service_config.py` или `user_config.py`

### Добавление новых форматов импорта
1. Создать парсер в `logic/` (следовать паттернам существующих XML-парсеров)
2. Зарегистрировать парсер в фасаде `importers.py`
3. Добавить логику определения формата
4. Включить тестовые случаи с примерами файлов

### Изменение шаблонов экспорта
1. Обновить файлы шаблонов в `templates/`
2. Скорректировать логику рендеринга в `excel_exporter.py`
3. Протестировать с различными конфигурациями проектов

---

## Перспективы развития

- **API-слой**: RESTful API для внешних интеграций
- **Серверная БД**: Замена JSON-персистентности на SQL-базу данных
- **Облачное хранилище**: Прямая интеграция с облачными провайдерами хранения
- **Функции совместной работы**: Многопользовательское редактирование проектов
- **Аналитика**: Отслеживание использования и дашборд отчётности