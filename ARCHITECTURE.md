# Архитектура RateApp

## Общий обзор
RateApp — настольное приложение на PySide6, организованное по слоям UI → бизнес-логика → сервисы интеграции.
Графический слой отвечает только за взаимодействие с пользователем и делегирует вычисления и I/O отдельным
модулям `logic/` и `services/`. Данные проектов могут поступать из файлов Trados/Smartcat, Outlook, Excel или
SharePoint, обрабатываются централизованно и экспортируются в Excel/PDF.

## Слои и основные каталоги
- **main.py** — точка входа, инициализирует конфигурацию, локализацию и главное окно.
- **gui/** — виджеты PySide6, панели и диалоги. Работают с моделями из `logic/`.
- **logic/** — бизнес-правила: расчёты, импорт отчётов, работа с конфигурациями, экспорт шаблонов.
- **services/** — лёгкие адаптеры для сторонних API и интеграция с легаси-вкладками (Excel/MS Graph).
- **utils/resource_utils.py** — поиск ресурсов (шаблоны, переводы) как в dev-режиме, так и в сборке PyInstaller.
- **templates/** — статические ресурсы для выгрузки КП.
- **updater/** — проверка обновлений, работа с метаданными релизов и пакетами обновлений.
- **tests/** — юнит-тесты, покрывающие расчёты, парсеры и сервисные функции.

## Модули интерфейса (`gui/`)
- `gui/__init__.py` — регистрация основных виджетов.
- `gui/main_window.py` (если присутствует) — композиция главного окна и связывание панелей.
- `gui/panels/` — набор панелей (карточка проекта, языковые пары, дополнительные услуги, лог) использующих модели из `logic/`.
- `gui/dialogs/` — диалоги выбора файлов, настроек и подтверждений.
- `gui/models/` — модели таблиц/деревьев Qt для отображения расчётов и импортированных данных.

## Бизнес-логика (`logic/`)
- `calculations.py` — перерасчёт объёмов, валют, скидок, налогов и итоговых сумм.
- `excel_exporter.py` — сборка коммерческого предложения в Excel на основе шаблонов.
- `excel_process.py` — вспомогательные функции чтения и нормализации Excel-данных.
- `importers.py` — фасады для импорта отчётов, зависящие от конкретных парсеров.
- `language_codes.py` — нормализация кодов языков, интеграция с `langcodes`/`Babel`.
- `language_pairs.py` — модель языковых пар, управление пользовательским справочником.
- `legal_entities.py` и `legal_entities.json` — справочник юрлиц и утилиты выборки.
- `logging_utils.py` — настройка логирования и управление файлами журналов.
- `ms_graph_client.py` — низкоуровневая работа с Microsoft Graph (MSAL, загрузка файлов по пути и `fileId`).
- `online_rates.py` — хранение и пересчёт курсов валют, взаимодействие с внешними источниками при необходимости.
- `outlook_import/` — парсинг `.msg` (заголовки, тело, таблицы) в структуру проекта.
- `pm_store.py` — история проджект-менеджеров и автоподстановка контактных данных.
- `progress.py` — утилиты отображения прогресса долгих операций в UI.
- `project_io.py` — чтение и запись проектов в JSON, управление совместимостью версий.
- `project_manager.py` — агрегатор состояний проекта, связывает карточку, пары, услуги и расчёты.
- `sc_xml_parser.py` и `trados_xml_parser.py` — парсеры отчётов Smartcat и Trados.
- `service_config.py` — загрузка `.env`, настройка путей и переключение окружений.
- `translation_config.py` — локализация интерфейса и терминологии.
- `user_config.py` — сохранение пользовательских настроек (валюта по умолчанию, язык интерфейса и т.п.).
- `xml_parser_common.py` — общие утилиты для разбора XML-отчётов.

## Сервисы (`services/`)
- `excel_export.py` — вспомогательные функции экспорта таблиц Qt в Excel (легаси-вкладки, LogTab, MemoQ) с автоформатированием.
- `ms_graph.py` — совместимый с легаси API слой над `logic.ms_graph_client`, нормализует скоупы, логирует ошибки и возвращает готовые `DataFrame`.

## Прочие компоненты
- `requirements.txt` — список внешних зависимостей и их минимальных версий.
- `main.spec` — сценарий PyInstaller: упаковка бинарей, шаблонов и переводов.
- `RateApp.exe.sha256`, `rateapp.ico` — артефакты сборки и иконка приложения.
- `updater/` — описания релизов, загрузка и проверка обновлений перед установкой.

## Потоки данных
1. **Импорт** — пользователь перетаскивает отчёты XML/MSG/Excel или запускает загрузку через Microsoft Graph; данные проходят через `importers.py`, парсеры и модели языковых пар.
2. **Обработка** — `project_manager.py` агрегирует структуры, `calculations.py` подсчитывает стоимость, `online_rates.py` обновляет курсы, `project_io.py` отвечает за сохранение промежуточного состояния.
3. **Дополнительные услуги** — модули `language_pairs.py`, `pm_store.py`, `user_config.py` и `legal_entities.py` предоставляют справочники и параметры для UI.
4. **Экспорт и обновления** — `excel_exporter.py`, `services/excel_export.py` и `pdf_exporter.py` формируют выдачу, а `updater/` и `ms_graph_client.py` взаимодействуют с внешними сервисами.

Такое разделение позволяет развивать бизнес-логику и интеграции независимо от интерфейса и обеспечивает повторное использование сервисов в легаси-компонентах.
