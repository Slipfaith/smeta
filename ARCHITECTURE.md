# Архитектура RateApp

## Общий обзор

RateApp — настольное приложение на PySide6, построенное по многоуровневой схеме **UI → бизнес-логика → сервисы интеграций**. Интерфейс отвечает за взаимодействие с пользователем, а вычисления, импорт/экспорт и интеграции вынесены в специализированные модули. Данные поступают из Trados/Smartcat, Outlook, Excel или Microsoft 365, централизованно обрабатываются и превращаются в коммерческие предложения.

Основные принципы:
- **Разделение ответственности** — UI не содержит бизнес-логики и обращается к слоям `logic/` и `services/`.
- **Повторное использование** — сервисы импорта и экспорта доступны как из главного окна, так и из встроенных утилит (например, панели ставок).
- **Готовность к упаковке** — `resource_utils.py`, `env_loader.py` и шаблоны обеспечивают одинаковую работу в dev-режиме и в сборке PyInstaller.

---

## Слои приложения

### 1. Точка входа
**`main.py`**
- загружает `.env` и настраивает логирование (`env_loader.load_application_env`, `logging_utils.setup_logging`);
- фиксирует запуск через `activity_logger`;
- создаёт `QApplication`, настраивает иконку и запускает главное окно `TranslationCostCalculator`;
- по завершении закрывает зависшие процессы Excel (`excel_process.close_excel_processes`).

### 2. Пользовательский интерфейс (`gui/`)
Слой представления на PySide6. Основные компоненты:
- **`main_window.py`** — композиция главного окна, меню, обработка перетаскивания и связка с `ProjectManager`;
- **`panels/`** — левая и правая панели с карточкой проекта, таблицами языковых пар и журналом расчётов;
- **`language_pair.py`** и **`additional_services.py`** — виджеты для расчётов по языковым парам и дополнительным услугам;
- **`project_setup_widget.py`** — управление блоком «Запуск и управление проектом» с таблицей работ, скидками и наценками;
- **`project_manager_dialog.py`** — выбор и редактирование проджект-менеджеров;
- **`rates_manager_window.py`** — встроенная панель тарифов с сопоставлением Excel-значений и подсветкой расхождений;
- **`drop_areas.py`** — обработка Drag & Drop для XML/MSG/Excel файлов;
- **`styles.py`**, **`utils.py`** — общие стили и форматирование значений.

Виджеты используют mixin `LanguagePairsMixin` и функции из `logic/` для пересчёта итогов, импорта и экспорта.

### 3. Бизнес-логика (`logic/`)
Содержит расчёты, работу с данными и интеграции.

**Управление проектами**
- `project_manager.py` — фасад операций (сохранение/загрузка проекта, экспорт в Excel/PDF, очистка);
- `project_data.py` — неизменяемый снимок проекта, используемый экспортерами и логами;
- `project_io.py` — сериализация/десериализация JSON-проектов с проверкой совместимости;
- `pm_store.py` — хранение истории проджект-менеджеров;
- `user_config.py` — пользовательские настройки и язык интерфейса.

**Расчёты и справочники**
- `calculations.py` — агрегирование итогов, скидок/наценок и налогов;
- `online_rates.py` — хранение и пересчёт валютных курсов;
- `language_pairs.py`, `language_codes.py` — модели языковых пар и нормализация кодов;
- `legal_entities.py` + `legal_entities.json` — справочник юридических лиц и путей к шаблонам.

**Импорт**
- `importers.py` — фасады импорта отчётов и тарифов;
- `sc_xml_parser.py`, `trados_xml_parser.py` и `xml_parser_common.py` — парсеры отчётов CAT-систем;
- `outlook_import/` — обработка Outlook `.msg` (карточка проекта, таблицы, вложения);
- `excel_process.py`, `rates_importer.py` — чтение Excel-файлов, нормализация колонок и применение тарифов;
- `ms_graph_client.py` — взаимодействие с Microsoft Graph (MSAL, загрузка по пути или `fileId`).

**Экспорт**
- `excel_exporter.py` — формирование коммерческих предложений на основе шаблонов;
- `pdf_exporter.py` — конвертация Excel → PDF через COM (Windows);
- `activity_logger.py` — запись ключевых действий в Markdown-лог для диагностики.

**Инфраструктура**
- `env_loader.py`, `service_config.py` — загрузка конфигурации и определение путей ресурсов;
- `logging_utils.py`, `activity_logger.py` — настройка логов и журналирование;
- `progress.py` — индикаторы долгих операций;
- `outlook_com_cache.py` — обслуживание COM-кэша Outlook на Windows;
- `app_info.py` — метаданные приложения (версия, автор).

### 4. Сервисы интеграций (`services/`)
Лёгкие адаптеры, обеспечивающие совместимость с легаси-компонентами:
- `excel_export.py` — экспорт Qt-таблиц (LogTab, MemoQ и др.) в Excel с автоформатированием;
- `ms_graph.py` — высокоуровневая обёртка над `ms_graph_client` с возвратом `pandas.DataFrame` и логированием ошибок.

---

## Вспомогательные каталоги и ресурсы
- **`templates/`** — Excel-шаблоны, логотипы и вспомогательные файлы для экспорта.
- **`rates1/`** — встроенные вкладки легаси-инструмента тарифов, переиспользуемые в `rates_manager_window.py`.
- **`utils/`** — небольшие утилиты интерфейса (`history.py`, `theme.py`).
- **`tests/`** — pytest-сuite, покрывающий расчёты, импортеры, экспорт и вспомогательные модули.
- **`resource_utils.py`** — единый механизм поиска ресурсов для разработки и PyInstaller.
- **`requirements.txt`**, **`main.spec`**, **`rateapp.ico`**, **`RateApp.exe.sha256`** — инфраструктурные файлы сборки.

---

## Потоки данных

### 1. Импорт
```text
Пользователь (Drag & Drop / выбор файла / Microsoft Graph)
    ↓
logic/importers.py
    ↓
Парсеры форматов (XML, Outlook MSG, Excel)
    ↓
language_pairs.py / ProjectSetupWidget / AdditionalServicesWidget
    ↓
ProjectManager + ProjectData
```
**Источники:**
- XML-отчёты Trados и Smartcat;
- Outlook `.msg` (карточка проекта, таблицы объёмов, вложения);
- Excel-тарифы локально и через Microsoft Graph.

### 2. Обработка
```text
ProjectManager (агрегация состояния)
    ↓
calculations.py (пересчёт итогов, скидок, НДС)
    ↓
online_rates.py (конвертация валют)
    ↓
project_data.py (снимок для экспорта/логов)
```
Справочники (`legal_entities`, `pm_store`, `user_config`) предоставляют метаданные и пользовательские настройки.

### 3. Экспорт
```text
Запрос пользователя (меню «Экспорт»)
    ↓
project_manager.py
    ↓
excel_exporter.py  ──→  шаблоны в templates/
    └── pdf_exporter.py (при необходимости, Windows)
    ↓
Выходные файлы (Excel / PDF / JSON)
```
Параллельно `activity_logger` сохраняет структурированные записи действий и прикрепляет снимки данных проекта.

### 4. Внешние сервисы
```text
Microsoft Graph запросы ← ms_graph_client.py → MSAL аутентификация
    ↓
services/ms_graph.py (нормализация и кеширование результатов)
```

---

## Дизайн-решения и преимущества
- **Поддерживаемость** — чёткое разделение интерфейса, логики и сервисов упрощает внесение изменений.
- **Расширяемость** — новые парсеры, шаблоны и источники тарифов добавляются без модификации существующего UI.
- **Диагностика** — расширенные логи (`logging_utils`, `activity_logger`) помогают анализировать действия пользователей.
- **Готовность к сборке** — все ресурсы и конфигурации доступны как в исходниках, так и в PyInstaller-пакете.
